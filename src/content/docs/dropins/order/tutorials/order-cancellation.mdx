---
title: Order Cancellation
description: Learn the Order Cancellation workflow.
---

import Diagram from '@components/Diagram.astro';
import OptionsTable from '@components/OptionsTable.astro';

The Order dropin allows both logged in and guest users to cancel an order.

In this tutorial, we will show:
- the requirements to be able to cancel an order,
- the cancellation workflow, and
- the queries and mutations involved in the order cancellation process.

## Requirements

To be able to cancel an order, you need to have the configuration enabled in the backend.
You can find it in the backoffice under *Stores > Configuration > Sales > Sales > Order Cancellation*.

There are the following configurations:
  <OptionsTable
    compact
    options={[
    ['Configuration', 'Description'],
    ['Order cancellation through GraphQL', 'It is a boolean. When it is set to `true`, the order cancellation will be enabled.'],
    ['Order cancellation reasons', 'It is an array of reasons that can be selected by the user when cancelling an order.'],
    ]}
  />

:::note[Note]
Note: There is a default list of reasons, but you can customise according to your needs.
:::

<Diagram caption="The order cancellation configurations you can customise in the backoffice">
  ![Cancellation configurations in the backoffice](@images/dropins/order/requirements-cancellation-configs.png)
</Diagram>

## Workflow

Generally speaking, the workflow for order cancellation is as follows:
- The user selects an order to cancel.
- Submits the cancellation form after selecting a cancellation reason.
- In case it is a logged-in user, the order is `Canceled` immediately.
- But if it is a guest user, an email is sent with a link to confirm the cancellation. Once the user clicks the link, the order is `Canceled`.

Let's review more in detail the workflow for a guest order cancellation:

### Select an order to cancel

The guest user provides the details to load an order to cancel:

<Diagram caption="Form presented to the guest user to load order details.">
  ![Guest user provides order details](@images/dropins/order/workflow-select-order-to-cancel.png)
</Diagram>

### Submit the form

The guest user is able to select a cancellation reason and submit the form:

<Diagram caption="Form presented to the guest user with different cancellation reasons.">
  ![Guest user selects a cancellation reason](@images/dropins/order/workflow-select-cancellation-reason.png)
</Diagram>

After submitting the form, the changes are reflected on the *Order Status* page:

<Diagram caption="Guest user is notified that cancellation has been requested.">
  ![Cancellation has been requested](@images/dropins/order/workflow-cancellation-requested.png)
</Diagram>

### Confirm order cancellation

The guest order remains in status `Pending` until the user clicks the link in the email to confirm the cancellation.
After that, the order becomes `Canceled` and *Order Status* page is updated accordingly.

## Queries & Mutations

There are different GraphQl queries and mutations involved in the order cancellation process.
They are described below.

:::note[Note]
The GraphQL queries and mutations shown below are part of Storefront Compatibility Package and will be added for 2.4.8 beta2.
:::

### Guest Order

This query is used to get the `token` for the guest order using the `email`, `order number`, and `postcode`:

```graphql
query guestOrder($email: String!, $number: String!, $postcode: String!) {
  guestOrder(
    input: {
      email: $email
      number: $number
      postcode: $postcode
    }
  ) {
    token
  }
}
```

The `token` you get from the above query is necessary to request the cancellation of the guest order as you can see below.

### Request guest order cancel

The following mutation is used to request the cancellation of the guest order based on the `token` and the `reason` selected by the user:

```graphql
mutation requestGuestOrderCancel($token: String!, $reason: String!) {
  requestGuestOrderCancel(input: { token: $token, reason: $reason }) {
		error
    order {
      status
      id
      token
    }
  }
}
```

After requesting the cancellation, an email is sent to the user with a link to confirm it.
This link contains the `order_id` and a `confirmation_key` generated on the fly during this process.
Both are necessary to confirm the cancellation of the order as you can see below.

### Confirm guest order cancel

The following mutation is used to confirm the cancellation of the guest order based on the `order_id` and the `confirmation_key`:

```graphql
mutation {
  confirmCancelOrder(input: { order_id: 9999999, confirmation_key: "tkKMveHSSXelEoKJk7fgTH7yazKO5kng" }) {
    errorV2 {
      message
    }
    order {
      status
    }
  }
}
```
