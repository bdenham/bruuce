---
import { getCollection } from 'astro:content';

// Get current URL for active state highlighting
const currentPath = Astro.url.pathname;

// Get only the latest 2 blog posts to minimize DOM
const blogPosts = await getCollection('blog');
const latestPosts = blogPosts
  .sort((a, b) => b.data.date.valueOf() - a.data.date.valueOf())
  .slice(0, 2); // Limit to 2 posts for performance
---

<!-- CSS-only sidebar toggle using checkbox hack -->
<input type="checkbox" id="sidebar-toggle" class="sidebar-checkbox" aria-label="Toggle sidebar" />

<aside class="sidebar" id="sidebar">
  <nav class="nav" id="nav">
    <!-- CSS-only close button for mobile -->
    <label for="sidebar-toggle" class="close" aria-label="Close sidebar">Ã—</label>

    <!-- Ultra-minimal navigation - no nested spans -->
    <div class="section">
      <a href="/" class={currentPath === '/' ? 'active' : ''}>Home</a>
      <a href="/about/" class={currentPath.startsWith('/about') ? 'active' : ''}>About Me</a>
      <a href="/work/" class={currentPath.startsWith('/work') ? 'active' : ''}>My Work</a>
      <a href="/resume/" class={currentPath.startsWith('/resume') ? 'active' : ''}>My Resume</a>
      <a href="/projects/" class={currentPath.startsWith('/projects') ? 'active' : ''}
        >My Projects</a
      >
      <a href="/blog/" class={currentPath.startsWith('/blog/') ? 'active' : ''}>My Blog</a>
    </div>

    <!-- Minimal blog section - max 2 posts -->
    <div class="section">
      <h3>Recent Posts</h3>
      {
        latestPosts.map((post) => (
          <a
            href={`/blog/${post.slug}/`}
            class={currentPath === `/blog/${post.slug}/` ? 'active' : ''}
          >
            {post.data.title.length > 25
              ? post.data.title.substring(0, 25) + '...'
              : post.data.title}
          </a>
        ))
      }
    </div>

    <!-- Minimal connect -->
    <div class="section">
      <h3>Let's Connect!</h3>
      <a href="https://linkedin.com/in/brucedenham/" target="_blank" rel="noopener">LinkedIn</a>
      <a href="https://github.com/bdenham" target="_blank" rel="noopener">GitHub</a>
    </div>
  </nav>

  <!-- Clickable overlay to close sidebar -->
  <label for="sidebar-toggle" class="overlay" aria-label="Close sidebar"></label>
</aside>

<style>
  /* CSS-only sidebar toggle using checkbox hack */
  .sidebar-checkbox {
    display: none; /* Hide the actual checkbox */
  }

  /* Sidebar visibility controlled by checkbox */
  .sidebar-checkbox:checked ~ .sidebar {
    transform: translateX(0) !important;
  }

  /* Prevent body scroll when sidebar is open */
  .sidebar-checkbox:checked ~ * {
    overflow: hidden;
  }

  /* Minimal sidebar styles - maximum performance */
  .sidebar {
    position: fixed;
    top: 70px; /* Standard header height */
    left: 0;
    height: calc(100vh - 60px); /* Adjust height to account for header */
    width: 280px;
    z-index: 200;
  }

  .nav {
    background: var(--bg-tertiary);
    height: 100%;
    overflow-y: auto;
    padding: 0;
    border-right: 1px solid var(--border-primary);
    position: relative;
    padding-top: 1.5rem;
  }

  .close {
    background: none;
    border: none;
    font-size: 1.25rem;
    color: var(--text-secondary);
    cursor: pointer;
    display: none;
    position: absolute;
    top: 16px; /* Reduced from 16px to pull it higher */
    right: 16px; /* Also reduce right spacing */
    z-index: 370;
  }

  /* Flat section structure - no nested elements */
  .section {
    margin-bottom: 24px; /* Add spacing between sections */
    padding: 0; /* Remove padding from section */
  }

  .section:first-of-type {
    padding-top: 0; /* Consistent top spacing for both desktop and mobile */
  }

  .section h3 {
    padding: 12px 24px 12px 32px;
    font-size: 1rem;
    font-weight: 600;
    color: var(--accent-primary); /* Use primary accent color instead of yellow */
    /* text-transform: uppercase; */
    /* letter-spacing: .5px; */
  }

  .section h3 a {
    color: inherit;
    text-decoration: none;
    display: inline; /* Keep it inline like regular text */
  }

  .section h3 a:hover {
    color: var(--accent-primary);
  }

  /* Minimal link styling - single element */
  .section a {
    display: block;
    padding: 0.5rem 1.5rem 0.5rem 2rem; /* Extra left padding for better visual spacing */
    color: var(--text-secondary);
    text-decoration: none;
    border-radius: 0;
    font-size: 1rem;
    font-weight: 300;
    margin: 0 0 0 0;
  }

  .section a:hover {
    color: var(--accent-primary);
    background: var(--sidebar-background);
  }

  .section a.active {
    color: var(--accent-primary);
    background: var(--sidebar-background);
    font-weight: 500;
  }

  /* Hide overlay completely on desktop */
  .overlay {
    display: none;
  }

  /* Mobile - fixed positioning and z-index */
  @media (max-width: 1023px) {
    .sidebar {
      z-index: 0; /* Fix: Don't block back button */
      display: contents; /* Make container transparent to layout - fixes Back to Home clicking! */
    }

    .nav {
      transform: translateX(-100%);
      transition: transform 0.3s ease;
      position: fixed;
      height: calc(100vh - 60px); /* Adjust height for header */
      width: 280px;
      z-index: 350; /* Above overlay, below toggle */
      padding-top: 1.75rem;
    }

    .sidebar-checkbox:checked ~ .sidebar .nav {
      transform: translateX(0);
    }

    .close {
      display: block;
      z-index: 360; /* Above nav content */
      position: relative;
    }

    .overlay {
      display: block; /* Show overlay only on mobile */
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.3);
      opacity: 0;
      visibility: hidden;
      transition:
        opacity 0.3s ease,
        visibility 0.3s ease;
      z-index: 250; /* Below sidebar but above content */
      pointer-events: none;
      cursor: pointer; /* Indicate it's clickable */
    }

    .sidebar-checkbox:checked ~ .sidebar .overlay {
      opacity: 1;
      visibility: visible;
      pointer-events: auto;
    }

    /* Ensure nav links work properly on mobile */
    .sidebar-checkbox:checked ~ .sidebar .nav a {
      pointer-events: auto;
      position: relative;
      z-index: 360;
    }

    /* Adjust mobile section padding to account for close button */
    .sidebar-checkbox:checked ~ .sidebar .section:first-of-type {
      padding-top: 28px; /* Minimal padding to match desktop visual spacing */
      /* margin-top: -8px; Negative margin to pull content up further */
    }

    /* Mobile touch target improvements - reduced spacing */
    .section a {
      display: block;
      padding: 0.5rem 1.5rem 0.5rem 2rem; /* Extra left padding for better visual spacing */
      color: var(--text-secondary);
      text-decoration: none;
      border-radius: 0;
      font-size: 1rem;
      font-weight: 300;
      margin: 0 0 0 0;
    }

    .section {
      margin-bottom: 24px; /* Reasonable space between sections */
    }
  }

  /* Global body class for sidebar open state */
  :global(body.sidebar-open) {
    overflow: hidden !important;
  }
</style>

<!-- CSS-only sidebar - no JavaScript needed -->
