---
import { getCollection } from 'astro:content';

// Get current URL for active state highlighting
const currentPath = Astro.url.pathname;

// Get only the latest 2 blog posts to minimize DOM
const blogPosts = await getCollection('blog');
const latestPosts = blogPosts
  .sort((a, b) => b.data.date.valueOf() - a.data.date.valueOf())
  .slice(0, 2); // Limit to 2 posts for performance
---

<aside class="sidebar" id="sidebar">
  <!-- Simplified mobile toggle - single element -->
  <button class="sidebar-toggle" id="toggle" aria-label="Menu">‚ò∞</button>

  <nav class="nav" id="nav">
    <!-- Close button for mobile (positioned at top right) -->
    <button class="close" id="close">√ó</button>

    <!-- Ultra-minimal navigation - no nested spans -->
    <div class="section">
      <a href="/" class={currentPath === '/' ? 'active' : ''}>üè† Home</a>
      <a href="/about/" class={currentPath.startsWith('/about') ? 'active' : ''}>üë®‚Äçüíª About</a>
      <a href="/resume/" class={currentPath.startsWith('/resume') ? 'active' : ''}>üìã Resume</a>
      <a href="/work/" class={currentPath.startsWith('/work') ? 'active' : ''}>üõ†Ô∏è Work</a>
      <a href="/projects/" class={currentPath.startsWith('/projects') ? 'active' : ''}
        >üöÄ Projects</a
      >
    </div>

    <!-- Minimal blog section - max 2 posts -->
    <div class="section">
      <h3><a href="/blog/" class={currentPath === '/blog/' ? 'active' : ''}>Blog ‚Üí</a></h3>
      {
        latestPosts.map((post) => (
          <a
            href={`/blog/${post.slug}/`}
            class={currentPath === `/blog/${post.slug}/` ? 'active' : ''}
          >
            {post.data.title.length > 25
              ? post.data.title.substring(0, 25) + '...'
              : post.data.title}
          </a>
        ))
      }
    </div>

    <!-- Minimal connect -->
    <div class="section">
      <h3>Connect</h3>
      <a href="https://linkedin.com/in/brucedenham/" target="_blank" rel="noopener">üíº LinkedIn</a>
      <a href="https://github.com/bdenham" target="_blank" rel="noopener">üíª GitHub</a>
    </div>
  </nav>

  <!-- Single overlay element -->
  <div class="overlay" id="overlay"></div>
</aside>

<style>
  /* Minimal sidebar styles - maximum performance */
  .sidebar {
    position: fixed;
    top: 60px; /* Standard header height */
    left: 0;
    height: calc(100vh - 60px); /* Adjust height to account for header */
    width: 280px;
    z-index: 200;
  }

  .sidebar-toggle {
    position: fixed;
    top: 70px; /* Just below header (60px header + 10px spacing) */
    left: 16px;
    width: 36px;
    height: 36px;
    background: var(--bg-card);
    border: 1px solid var(--border-secondary);
    border-top: none;
    border-radius: 6px;
    cursor: pointer;
    z-index: 300;
    display: none;
    align-items: center;
    justify-content: center;
    color: var(--text-primary);
    font-size: 16px;
  }

  .nav {
    background: var(--bg-secondary);
    height: 100%;
    overflow-y: auto;
    padding: 0;
    border-right: 1px solid var(--border-primary);
    position: relative; /* Relative positioning on desktop */
  }

  .close {
    background: none;
    border: none;
    font-size: 20px;
    color: var(--text-secondary);
    cursor: pointer;
    display: none;
    position: absolute;
    top: 16px; /* Reduced from 16px to pull it higher */
    right: 16px; /* Also reduce right spacing */
    z-index: 370;
  }

  /* Flat section structure - no nested elements */
  .section {
    margin-bottom: 0;
    padding: 0 24px;
  }

  .section:first-of-type {
    padding-top: 0; /* Consistent top spacing for both desktop and mobile */
  }

  .section h3 {
    margin: 0 0 6px 0;
    font-size: 14px;
    font-weight: 600;
    color: var(--accent-yellow); /* Match blog post date color */
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .section h3 a {
    color: inherit;
    text-decoration: none;
    display: inline; /* Keep it inline like regular text */
  }

  .section h3 a:hover {
    color: var(--accent-primary);
  }

  /* Minimal link styling - single element */
  .section a {
    display: block;
    padding: 8px 0;
    color: var(--text-secondary);
    text-decoration: none;
    border-radius: 6px;
    font-size: 14px;
    margin-bottom: 0;
  }

  .section a:hover,
  .section a.active {
    color: var(--accent-primary);
    background: var(--bg-card);
  }

  /* Hide overlay completely on desktop */
  .overlay {
    display: none;
  }

  /* Mobile - fixed positioning and z-index */
  @media (max-width: 1023px) {
    .sidebar {
      z-index: 0; /* Fix: Don't block back button */
    }

    .sidebar-toggle {
      display: flex;
      z-index: 400; /* Above everything */
    }

    .nav {
      transform: translateX(-100%);
      transition: transform 0.3s ease;
      position: fixed;
      top: 60px; /* Start below header on mobile too */
      height: calc(100vh - 60px); /* Adjust height for header */
      width: 280px;
      z-index: 350; /* Above overlay, below toggle */
    }

    .sidebar.open .nav {
      transform: translateX(0);
    }

    .close {
      display: block;
      z-index: 360; /* Above nav content */
      position: relative;
    }

    .overlay {
      display: block; /* Show overlay only on mobile */
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.3);
      opacity: 0;
      visibility: hidden;
      transition:
        opacity 0.3s ease,
        visibility 0.3s ease;
      z-index: 250; /* Below sidebar but above content */
      pointer-events: none;
    }

    .sidebar.open .overlay {
      opacity: 1;
      visibility: visible;
      pointer-events: auto;
    }

    /* Ensure nav links work properly on mobile */
    .sidebar.open .nav a {
      pointer-events: auto;
      position: relative;
      z-index: 360;
    }

    /* Adjust mobile section padding to account for close button */
    .sidebar.open .section:first-of-type {
      padding-top: 28px; /* Minimal padding to match desktop visual spacing */
      margin-top: -8px; /* Negative margin to pull content up further */
    }
  }

  /* Global body class for sidebar open state */
  :global(body.sidebar-open) {
    overflow: hidden !important;
  }
</style>

<script>
  // Ultra-minimal JavaScript - maximum performance
  document.addEventListener('DOMContentLoaded', function () {
    // Ensure body class is clean on page load
    document.body.classList.remove('sidebar-open');

    const sidebar = document.getElementById('sidebar');
    const toggle = document.getElementById('toggle');
    const close = document.getElementById('close');
    const overlay = document.getElementById('overlay');

    function open() {
      sidebar?.classList.add('open');
      document.body.classList.add('sidebar-open');
    }

    function closeNav() {
      sidebar?.classList.remove('open');
      document.body.classList.remove('sidebar-open');
    }

    function toggleSidebar() {
      if (sidebar?.classList.contains('open')) {
        closeNav();
      } else {
        open();
      }
    }

    // Minimal event listeners
    toggle?.addEventListener('click', toggleSidebar);
    close?.addEventListener('click', closeNav);
    overlay?.addEventListener('click', closeNav);

    // Escape key
    document.addEventListener('keydown', function (e) {
      if (e.key === 'Escape' && sidebar?.classList.contains('open')) {
        closeNav();
      }
    });

    // Auto-close on link click (mobile)
    if (window.matchMedia('(max-width: 1023px)').matches) {
      document.querySelectorAll('.section a[href^="/"]').forEach((link) => {
        link.addEventListener('click', closeNav);
      });
    }
  });
</script>
