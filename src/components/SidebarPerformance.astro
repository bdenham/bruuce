---
import { getCollection } from 'astro:content';

// Get current URL for active state highlighting
const currentPath = Astro.url.pathname;

// Get only the latest 2 blog posts to minimize DOM
const blogPosts = await getCollection('blog');
const latestPosts = blogPosts
  .sort((a, b) => b.data.date.valueOf() - a.data.date.valueOf())
  .slice(0, 2); // Limit to 2 posts for performance
---

<aside class="sidebar" id="sidebar">
  <!-- Simplified mobile toggle - single element -->
  <button class="sidebar-toggle" id="toggle" aria-label="Menu">‚ò∞</button>

  <nav class="nav" id="nav">
    <!-- Minimal header -->
    <div class="header">
      <a href="/" class="brand">Bruce Denham</a>
      <button class="close" id="close">√ó</button>
    </div>

    <!-- Ultra-minimal navigation - no nested spans -->
    <div class="section">
      <h3>Portfolio</h3>
      <a href="/" class={currentPath === '/' ? 'active' : ''}>üè† Home</a>
      <a href="/about/" class={currentPath.startsWith('/about') ? 'active' : ''}>üë®‚Äçüíª About</a>
      <a href="/resume/" class={currentPath.startsWith('/resume') ? 'active' : ''}>üìã Resume</a>
      <a href="/work/" class={currentPath.startsWith('/work') ? 'active' : ''}>üõ†Ô∏è Work</a>
      <a href="/projects/" class={currentPath.startsWith('/projects') ? 'active' : ''}
        >üöÄ Projects</a
      >
    </div>

    <!-- Minimal blog section - max 2 posts -->
    <div class="section">
      <h3><a href="/blog/" class={currentPath === '/blog/' ? 'active' : ''}>Blog ‚Üí</a></h3>
      {
        latestPosts.map((post) => (
          <a
            href={`/blog/${post.slug}/`}
            class={currentPath === `/blog/${post.slug}/` ? 'active' : ''}
          >
            {post.data.title.length > 25
              ? post.data.title.substring(0, 25) + '...'
              : post.data.title}
          </a>
        ))
      }
    </div>

    <!-- Minimal connect -->
    <div class="section">
      <h3>Connect</h3>
      <a href="https://linkedin.com/in/brucedenham/" target="_blank" rel="noopener">üíº LinkedIn</a>
      <a href="https://github.com/bdenham" target="_blank" rel="noopener">üíª GitHub</a>
    </div>
  </nav>

  <!-- Single overlay element -->
  <div class="overlay" id="overlay"></div>
</aside>

<style>
  /* Minimal sidebar styles - maximum performance */
  .sidebar {
    position: fixed;
    top: 0;
    left: 0;
    height: 100vh;
    width: 280px;
    z-index: 200;
  }

  .sidebar-toggle {
    position: fixed;
    top: 60px;
    left: 16px;
    width: 36px;
    height: 36px;
    background: var(--bg-card);
    border: 1px solid var(--border-secondary);
    border-radius: 6px;
    cursor: pointer;
    z-index: 300;
    display: none;
    align-items: center;
    justify-content: center;
    color: var(--text-primary);
    font-size: 16px;
  }

  .nav {
    background: var(--bg-secondary);
    height: 100%;
    overflow-y: auto;
    padding: 0;
    border-right: 1px solid var(--border-primary);
  }

  .header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 20px 24px;
    border-bottom: 1px solid var(--border-secondary);
    margin-bottom: 24px;
  }

  .brand {
    color: var(--accent-primary);
    text-decoration: none;
    font-size: 18px;
    font-weight: 600;
    margin: 0;
  }

  .close {
    background: none;
    border: none;
    font-size: 20px;
    color: var(--text-secondary);
    cursor: pointer;
    display: none;
  }

  /* Flat section structure - no nested elements */
  .section {
    margin-bottom: 32px;
    padding: 0 24px;
  }

  .section h3 {
    margin: 0 0 12px 0;
    font-size: 14px;
    font-weight: 600;
    color: var(--text-secondary);
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .section h3 a {
    color: inherit;
    text-decoration: none;
  }

  .section h3 a:hover {
    color: var(--accent-primary);
  }

  /* Minimal link styling - single element */
  .section a {
    display: block;
    padding: 8px 12px;
    color: var(--text-secondary);
    text-decoration: none;
    border-radius: 6px;
    font-size: 14px;
    margin-bottom: 4px;
  }

  .section a:hover,
  .section a.active {
    color: var(--accent-primary);
    background: var(--bg-card);
  }

  /* Mobile - simplified */
  @media (max-width: 1023px) {
    .sidebar-toggle {
      display: flex;
    }

    .nav {
      transform: translateX(-100%);
      transition: transform 0.3s ease;
      position: fixed;
      width: 280px;
      z-index: 350;
    }

    .sidebar.open .nav {
      transform: translateX(0);
    }

    .close {
      display: block;
    }

    .overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.3);
      opacity: 0;
      visibility: hidden;
      transition:
        opacity 0.3s ease,
        visibility 0.3s ease;
      z-index: 250;
      pointer-events: none;
    }

    .sidebar.open .overlay {
      opacity: 1;
      visibility: visible;
      pointer-events: auto;
    }
  }

  /* Global body class for sidebar open state */
  :global(body.sidebar-open) {
    overflow: hidden !important;
  }
</style>

<script>
  // Ultra-minimal JavaScript - maximum performance
  document.addEventListener('DOMContentLoaded', function () {
    const sidebar = document.getElementById('sidebar');
    const toggle = document.getElementById('toggle');
    const close = document.getElementById('close');
    const overlay = document.getElementById('overlay');

    function open() {
      sidebar?.classList.add('open');
      document.body.classList.add('sidebar-open');
    }

    function closeNav() {
      sidebar?.classList.remove('open');
      document.body.classList.remove('sidebar-open');
    }

    // Minimal event listeners
    toggle?.addEventListener('click', open);
    close?.addEventListener('click', closeNav);
    overlay?.addEventListener('click', closeNav);

    // Escape key
    document.addEventListener('keydown', function (e) {
      if (e.key === 'Escape' && sidebar?.classList.contains('open')) {
        closeNav();
      }
    });

    // Auto-close on link click (mobile)
    if (window.matchMedia('(max-width: 1023px)').matches) {
      document.querySelectorAll('.section a[href^="/"]').forEach((link) => {
        link.addEventListener('click', closeNav);
      });
    }
  });
</script>
